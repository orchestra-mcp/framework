id: OCD-76
type: task
parent: OCD-27
title: Build AI Agent control panel with WebSocket communication
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 40
estimate_tokens: null
blockers: ["OCD-75"]
description: "Create the AI Agent control page that communicates with the IDE's Claude Code agent via WebSocket.\n\n**Steps:**\n\n1. Create agent models and migration:\n```bash\ncd src/platform\nphp artisan make:model AgentSession -m\nphp artisan make:model AgentMessage -m\n```\n\nEdit `src/platform/database/migrations/*_create_agent_sessions_table.php`:\n```php\nSchema::create('agent_sessions', function (Blueprint $table) {\n    $table->id();\n    $table->foreignId('user_id')->constrained()->cascadeOnDelete();\n    $table->enum('status', ['idle', 'working', 'waiting_for_permission', 'waiting_for_answer', 'error'])->default('idle');\n    $table->string('current_task')->nullable();\n    $table->timestamp('started_at')->nullable();\n    $table->timestamps();\n});\n\nSchema::create('agent_messages', function (Blueprint $table) {\n    $table->id();\n    $table->foreignId('agent_session_id')->constrained()->cascadeOnDelete();\n    $table->foreignId('user_id')->constrained()->cascadeOnDelete();\n    $table->enum('type', ['output', 'prompt', 'permission_request', 'permission_response', 'question', 'answer', 'error']);\n    $table->enum('sender', ['agent', 'user']);\n    $table->text('content');\n    $table->json('metadata')->nullable();\n    $table->timestamps();\n    $table->index(['agent_session_id', 'created_at']);\n});\n```\n\n2. Create events:\n```bash\nphp artisan make:event AgentStatusChanged\nphp artisan make:event AgentMessageReceived\n```\n\nEdit `src/platform/app/Events/AgentStatusChanged.php`:\n```php\n<?php\nnamespace App\\Events;\n\nuse App\\Models\\AgentSession;\nuse Illuminate\\Broadcasting\\PrivateChannel;\nuse Illuminate\\Contracts\\Broadcasting\\ShouldBroadcast;\nuse Illuminate\\Foundation\\Events\\Dispatchable;\nuse Illuminate\\Broadcasting\\InteractsWithSockets;\nuse Illuminate\\Queue\\SerializesModels;\n\nclass AgentStatusChanged implements ShouldBroadcast\n{\n    use Dispatchable, InteractsWithSockets, SerializesModels;\n\n    public function __construct(public AgentSession $session) {}\n\n    public function broadcastOn(): array\n    {\n        return [new PrivateChannel(\"agent.{$this->session->user_id}\")];\n    }\n\n    public function broadcastWith(): array\n    {\n        return [\n            'session_id' => $this->session->id,\n            'status' => $this->session->status,\n            'current_task' => $this->session->current_task,\n        ];\n    }\n}\n```\n\n3. Create controller: `php artisan make:controller Dashboard/AgentController`\nEdit `src/platform/app/Http/Controllers/Dashboard/AgentController.php`:\n```php\n<?php\nnamespace App\\Http\\Controllers\\Dashboard;\n\nuse App\\Http\\Controllers\\Controller;\nuse App\\Events\\AgentMessageReceived;\nuse App\\Models\\AgentMessage;\nuse App\\Models\\AgentSession;\nuse Illuminate\\Http\\Request;\nuse Inertia\\Inertia;\n\nclass AgentController extends Controller\n{\n    public function index(Request $request)\n    {\n        $user = $request->user();\n        $session = AgentSession::where('user_id', $user->id)->latest()->first();\n\n        return Inertia::render('Dashboard/Agent', [\n            'session' => $session ? [\n                'id' => $session->id,\n                'status' => $session->status,\n                'current_task' => $session->current_task,\n                'started_at' => $session->started_at?->diffForHumans(),\n            ] : null,\n            'messages' => $session ? AgentMessage::where('agent_session_id', $session->id)\n                ->orderBy('created_at')\n                ->limit(100)\n                ->get()\n                ->map(fn ($m) => [\n                    'id' => $m->id, 'type' => $m->type, 'sender' => $m->sender,\n                    'content' => $m->content, 'metadata' => $m->metadata,\n                    'created_at' => $m->created_at->format('H:i:s'),\n                ]) : [],\n        ]);\n    }\n\n    public function sendPrompt(Request $request)\n    {\n        $request->validate(['prompt' => 'required|string|max:5000']);\n        $user = $request->user();\n        $session = AgentSession::where('user_id', $user->id)->latest()->firstOrFail();\n\n        $message = AgentMessage::create([\n            'agent_session_id' => $session->id,\n            'user_id' => $user->id,\n            'type' => 'prompt',\n            'sender' => 'user',\n            'content' => $request->prompt,\n        ]);\n\n        broadcast(new AgentMessageReceived($message))->toOthers();\n        return back();\n    }\n\n    public function respondToPermission(Request $request)\n    {\n        $request->validate(['approved' => 'required|boolean', 'message_id' => 'required|integer']);\n        $user = $request->user();\n        $session = AgentSession::where('user_id', $user->id)->latest()->firstOrFail();\n\n        $message = AgentMessage::create([\n            'agent_session_id' => $session->id,\n            'user_id' => $user->id,\n            'type' => 'permission_response',\n            'sender' => 'user',\n            'content' => $request->approved ? 'approved' : 'denied',\n            'metadata' => ['original_message_id' => $request->message_id],\n        ]);\n\n        $session->update(['status' => $request->approved ? 'working' : 'idle']);\n        broadcast(new AgentMessageReceived($message))->toOthers();\n        return back();\n    }\n\n    public function answerQuestion(Request $request)\n    {\n        $request->validate(['answer' => 'required|string|max:5000', 'message_id' => 'required|integer']);\n        $user = $request->user();\n        $session = AgentSession::where('user_id', $user->id)->latest()->firstOrFail();\n\n        $message = AgentMessage::create([\n            'agent_session_id' => $session->id,\n            'user_id' => $user->id,\n            'type' => 'answer',\n            'sender' => 'user',\n            'content' => $request->answer,\n            'metadata' => ['original_message_id' => $request->message_id],\n        ]);\n\n        $session->update(['status' => 'working']);\n        broadcast(new AgentMessageReceived($message))->toOthers();\n        return back();\n    }\n}\n```\n\n4. Create `src/platform/resources/js/Pages/Dashboard/Agent.tsx`:\n- Agent status indicator (idle=gray, working=green pulse, waiting=yellow pulse, error=red)\n- Message log showing agent output, permission requests, questions\n- Permission request cards with Approve/Deny buttons\n- Question cards with answer text input\n- Prompt input at bottom to send new instructions\n- Real-time updates via Echo channel `agent.{userId}`\n\n5. Add routes:\n```php\nRoute::get('/dashboard/agent', [AgentController::class, 'index'])->name('dashboard.agent');\nRoute::post('/dashboard/agent/prompt', [AgentController::class, 'sendPrompt'])->name('dashboard.agent.prompt');\nRoute::post('/dashboard/agent/permission', [AgentController::class, 'respondToPermission'])->name('dashboard.agent.permission');\nRoute::post('/dashboard/agent/answer', [AgentController::class, 'answerQuestion'])->name('dashboard.agent.answer');\n```\n\n**File paths:**\n- `src/platform/database/migrations/*_create_agent_sessions_table.php`\n- `src/platform/database/migrations/*_create_agent_messages_table.php`\n- `src/platform/app/Models/AgentSession.php`\n- `src/platform/app/Models/AgentMessage.php`\n- `src/platform/app/Events/AgentStatusChanged.php`\n- `src/platform/app/Events/AgentMessageReceived.php`\n- `src/platform/app/Http/Controllers/Dashboard/AgentController.php`\n- `src/platform/resources/js/Pages/Dashboard/Agent.tsx`\n- `src/platform/routes/web.php` (updated)"
acceptance_criteria[10]: "agent_sessions table with user_id, status enum, current_task, started_at","agent_messages table with session_id, user_id, type enum, sender enum, content, metadata JSON","AgentStatusChanged event broadcasts on agent.{userId} channel",Agent page at /dashboard/agent shows status indicator and message log,"Status indicator: idle (gray), working (green pulse), waiting (yellow pulse), error (red)",Permission request cards with Approve/Deny buttons,Question cards with answer text input and submit,Prompt input to send new instructions to agent,"POST endpoints for prompt, permission response, answer",Messages displayed in chronological order with timestamps

**Dependencies:**
This task requires the following tasks to be completed first: OCD-75
story: OCD-27
epic: OCD-5
project: oap-cloud
projectKey: OCD
path: .projects/oap-cloud/OCD-5/OCD-27/OCD-76.toon
