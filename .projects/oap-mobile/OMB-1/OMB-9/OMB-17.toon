id: OMB-17
type: task
parent: OMB-9
title: Install and configure Firebase (FCM) for iOS and Android
status: done
created: 2026-02-09
assignee: Claude
estimate_minutes: 45
estimate_tokens: null
actual_minutes: 15
actual_tokens: 3000
completed: 2026-02-10
blockers: []
description: "Install React Native Firebase and configure FCM for push notifications on both platforms.\n\n1. Install React Native Firebase:\n   ```bash\n   cd src/mobile\n   npm install @react-native-firebase/app@^21.0.0 @react-native-firebase/messaging@^21.0.0\n   ```\n\n2. Install react-native-keychain for secure storage:\n   ```bash\n   npm install react-native-keychain\n   ```\n\n3. **Android configuration:**\n   - Create placeholder `src/mobile/android/app/google-services.json` with this structure (developer must replace with real values):\n     ```json\n     {\n       \"project_info\": {\n         \"project_number\": \"REPLACE_ME\",\n         \"project_id\": \"orchestra-mobile\",\n         \"storage_bucket\": \"orchestra-mobile.appspot.com\"\n       },\n       \"client\": [{\n         \"client_info\": {\n           \"mobilesdk_app_id\": \"REPLACE_ME\",\n           \"android_client_info\": {\n             \"package_name\": \"com.orchestramobile\"\n           }\n         },\n         \"api_key\": [{ \"current_key\": \"REPLACE_ME\" }]\n       }],\n       \"configuration_version\": \"1\"\n     }\n     ```\n   - Verify `src/mobile/android/build.gradle` has `classpath 'com.google.gms:google-services:4.4.0'` in buildscript dependencies\n   - Verify `src/mobile/android/app/build.gradle` has `apply plugin: 'com.google.gms.google-services'` at the bottom\n\n4. **iOS configuration:**\n   - Create placeholder `src/mobile/ios/OrchestraMobile/GoogleService-Info.plist` with the required Firebase plist structure (developer must replace with real values from Firebase console)\n   - Run `cd ios && pod install` to link Firebase native modules\n   - In `src/mobile/ios/OrchestraMobile/AppDelegate.mm`, add Firebase import and configure:\n     ```objc\n     #import <Firebase.h>\n     // In didFinishLaunchingWithOptions:\n     [FIRApp configure];\n     ```\n\n5. Create `src/mobile/src/services/pushNotificationService.ts`:\n   ```typescript\n   import messaging, { FirebaseMessagingTypes } from '@react-native-firebase/messaging';\n   import { Platform, PermissionsAndroid } from 'react-native';\n   import { useNotificationStore } from '@stores/notificationStore';\n\n   class PushNotificationService {\n     async requestPermission(): Promise<boolean> {\n       if (Platform.OS === 'android' && Platform.Version >= 33) {\n         const granted = await PermissionsAndroid.request(\n           PermissionsAndroid.PERMISSIONS.POST_NOTIFICATIONS,\n         );\n         return granted === PermissionsAndroid.RESULTS.GRANTED;\n       }\n\n       const authStatus = await messaging().requestPermission();\n       return (\n         authStatus === messaging.AuthorizationStatus.AUTHORIZED ||\n         authStatus === messaging.AuthorizationStatus.PROVISIONAL\n       );\n     }\n\n     async getToken(): Promise<string | null> {\n       try {\n         const token = await messaging().getToken();\n         console.log('[FCM] Token:', token);\n         return token;\n       } catch (error) {\n         console.error('[FCM] Failed to get token:', error);\n         return null;\n       }\n     }\n\n     onMessage(callback: (message: FirebaseMessagingTypes.RemoteMessage) => void): () => void {\n       return messaging().onMessage(callback);\n     }\n\n     onNotificationOpenedApp(callback: (message: FirebaseMessagingTypes.RemoteMessage) => void): () => void {\n       return messaging().onNotificationOpenedApp(callback);\n     }\n\n     async getInitialNotification(): Promise<FirebaseMessagingTypes.RemoteMessage | null> {\n       return messaging().getInitialNotification();\n     }\n\n     onTokenRefresh(callback: (token: string) => void): () => void {\n       return messaging().onTokenRefresh(callback);\n     }\n   }\n\n   export const pushNotificationService = new PushNotificationService();\n   ```\n\n6. Add to `src/mobile/src/services/index.ts`:\n   ```typescript\n   export { pushNotificationService } from './pushNotificationService';\n   ```\n\n7. Create `src/mobile/src/services/secureStorage.ts`:\n   ```typescript\n   import * as Keychain from 'react-native-keychain';\n\n   const SERVICE_NAME = 'com.orchestra.mobile';\n\n   export const secureStorage = {\n     async setToken(token: string): Promise<void> {\n       await Keychain.setGenericPassword('auth_token', token, { service: SERVICE_NAME });\n     },\n\n     async getToken(): Promise<string | null> {\n       try {\n         const credentials = await Keychain.getGenericPassword({ service: SERVICE_NAME });\n         if (credentials) {\n           return credentials.password;\n         }\n         return null;\n       } catch {\n         return null;\n       }\n     },\n\n     async removeToken(): Promise<void> {\n       await Keychain.resetGenericPassword({ service: SERVICE_NAME });\n     },\n   };\n   ```\n\n8. Verify: App builds on both platforms. FCM token can be retrieved (may need a real google-services.json for full testing)."
acceptance_criteria[8]: @react-native-firebase/app and @react-native-firebase/messaging installed,react-native-keychain installed,Placeholder google-services.json exists for Android,Placeholder GoogleService-Info.plist exists for iOS,"pushNotificationService.ts has methods: requestPermission, getToken, onMessage, onNotificationOpenedApp, getInitialNotification, onTokenRefresh","secureStorage.ts provides setToken, getToken, removeToken using react-native-keychain",iOS pod install succeeds,App builds on both platforms without Firebase initialization crashes (placeholder configs may show warnings but not crashes)

**Dependencies:**
This task requires the following tasks to be completed first: OMB-16

**⚠️ Design System Dependency:**
This task requires the Orchestra Design System foundation to be completed first (ODS-1, ODS-2). Use design tokens and core components from `packages/design-system/` instead of creating custom styles.
story: OMB-9
epic: OMB-1
project: oap-mobile
projectKey: OMB
path: .projects/oap-mobile/OMB-1/OMB-9/OMB-17.toon
