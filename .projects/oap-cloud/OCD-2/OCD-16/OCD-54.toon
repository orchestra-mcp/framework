id: OCD-54
type: task
parent: OCD-16
title: Create UserSettings class and settings page
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 30
estimate_tokens: null
description: "Create a per-user settings class using Spatie Settings and the settings page.\n\n**Steps:**\n\n1. Create user settings class at `src/platform/app/Settings/UserSettings.php`:\n```php\n<?php\nnamespace App\\Settings;\n\nuse Spatie\\LaravelSettings\\Settings;\n\nclass UserSettings extends Settings\n{\n    public string $theme; // 'light', 'dark', 'system'\n    public string $timezone;\n    public string $language;\n    public bool $notify_email;\n    public bool $notify_in_app;\n    public bool $notify_push;\n    public bool $notify_agent_alerts;\n\n    public static function group(): string\n    {\n        return 'user';\n    }\n}\n```\n\n2. Create migration: `php artisan make:settings-migration CreateUserSettings`\nEdit the migration:\n```php\nuse Spatie\\LaravelSettings\\Migrations\\SettingsMigration;\n\nclass CreateUserSettings extends SettingsMigration\n{\n    public function up(): void\n    {\n        $this->migrator->add('user.theme', 'system');\n        $this->migrator->add('user.timezone', 'UTC');\n        $this->migrator->add('user.language', 'en');\n        $this->migrator->add('user.notify_email', true);\n        $this->migrator->add('user.notify_in_app', true);\n        $this->migrator->add('user.notify_push', true);\n        $this->migrator->add('user.notify_agent_alerts', true);\n    }\n}\n```\n\nNOTE: Spatie Settings by default are global, not per-user. To make them per-user, we need a custom approach. Create a `user_settings` table instead:\n\n3. Create migration: `php artisan make:migration create_user_settings_table`\n```php\nSchema::create('user_settings', function (Blueprint $table) {\n    $table->id();\n    $table->foreignId('user_id')->constrained()->cascadeOnDelete();\n    $table->string('key');\n    $table->text('value')->nullable();\n    $table->timestamps();\n    $table->unique(['user_id', 'key']);\n});\n```\n\n4. Create model at `src/platform/app/Models/UserSetting.php`:\n```php\n<?php\nnamespace App\\Models;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n\nclass UserSetting extends Model\n{\n    protected $fillable = ['user_id', 'key', 'value'];\n\n    public function user(): BelongsTo\n    {\n        return $this->belongsTo(User::class);\n    }\n}\n```\n\n5. Add helper to User model at `src/platform/app/Models/User.php`:\n```php\npublic function settings()\n{\n    return $this->hasMany(UserSetting::class);\n}\n\npublic function getSetting(string $key, mixed $default = null): mixed\n{\n    $setting = $this->settings()->where('key', $key)->first();\n    return $setting ? json_decode($setting->value, true) : $default;\n}\n\npublic function setSetting(string $key, mixed $value): void\n{\n    $this->settings()->updateOrCreate(\n        ['key' => $key],\n        ['value' => json_encode($value)]\n    );\n}\n\npublic function getSettings(): array\n{\n    $defaults = [\n        'theme' => 'system',\n        'timezone' => 'UTC',\n        'language' => 'en',\n        'notify_email' => true,\n        'notify_in_app' => true,\n        'notify_push' => true,\n        'notify_agent_alerts' => true,\n    ];\n    $userSettings = $this->settings->pluck('value', 'key')->map(fn ($v) => json_decode($v, true))->toArray();\n    return array_merge($defaults, $userSettings);\n}\n```\n\n6. Create controller at `src/platform/app/Http/Controllers/UserSettingsController.php`:\n```php\n<?php\nnamespace App\\Http\\Controllers;\n\nuse Illuminate\\Http\\Request;\nuse Inertia\\Inertia;\n\nclass UserSettingsController extends Controller\n{\n    public function show(Request $request)\n    {\n        return Inertia::render('Settings/Index', [\n            'settings' => $request->user()->getSettings(),\n            'timezones' => \\DateTimeZone::listIdentifiers(),\n        ]);\n    }\n\n    public function update(Request $request)\n    {\n        $validated = $request->validate([\n            'theme' => 'required|in:light,dark,system',\n            'timezone' => 'required|timezone',\n            'language' => 'required|in:en,es,fr,de,ja,zh',\n            'notify_email' => 'boolean',\n            'notify_in_app' => 'boolean',\n            'notify_push' => 'boolean',\n            'notify_agent_alerts' => 'boolean',\n        ]);\n\n        foreach ($validated as $key => $value) {\n            $request->user()->setSetting($key, $value);\n        }\n\n        return back()->with('status', 'Settings updated.');\n    }\n}\n```\n\n7. Create `src/platform/resources/js/Pages/Settings/Index.tsx`:\n```tsx\nimport { FormEvent } from 'react';\nimport { useForm } from '@inertiajs/react';\nimport AppLayout from '@/Layouts/AppLayout';\n\ninterface Props {\n    settings: {\n        theme: string; timezone: string; language: string;\n        notify_email: boolean; notify_in_app: boolean;\n        notify_push: boolean; notify_agent_alerts: boolean;\n    };\n    timezones: string[];\n}\n\nexport default function SettingsIndex({ settings, timezones }: Props) {\n    const { data, setData, put, processing } = useForm(settings);\n\n    const submit = (e: FormEvent) => {\n        e.preventDefault();\n        put('/settings');\n    };\n\n    return (\n        <AppLayout title=\"Settings\">\n            <div className=\"mx-auto max-w-2xl\">\n                <h2 className=\"mb-6 text-2xl font-bold text-gray-900\">Settings</h2>\n                <form onSubmit={submit} className=\"space-y-6\">\n                    {/* Appearance section, Notification toggles, timezone select, language select */}\n                    {/* ... full form with all fields ... */}\n                    <button type=\"submit\" disabled={processing}\n                        className=\"rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700\">\n                        Save Settings\n                    </button>\n                </form>\n            </div>\n        </AppLayout>\n    );\n}\n```\n\n8. Add routes in `src/platform/routes/web.php`:\n```php\nRoute::get('/settings', [UserSettingsController::class, 'show'])->name('settings.show');\nRoute::put('/settings', [UserSettingsController::class, 'update'])->name('settings.update');\n```\n\n**File paths:**\n- `src/platform/database/migrations/*_create_user_settings_table.php`\n- `src/platform/app/Models/UserSetting.php`\n- `src/platform/app/Models/User.php` (updated with settings methods)\n- `src/platform/app/Http/Controllers/UserSettingsController.php`\n- `src/platform/resources/js/Pages/Settings/Index.tsx`\n- `src/platform/routes/web.php` (updated)"
acceptance_criteria[8]: "user_settings table with user_id, key, value columns and unique constraint",UserSetting model with User relationship,"User model has getSetting(), setSetting(), getSettings() helper methods","Default settings: theme=system, timezone=UTC, language=en, all notifications=true",UserSettingsController show and update actions work,"Settings/Index.tsx renders form with theme, timezone, language, notification toggles",Settings persist and load correctly on page refresh,PUT /settings validates and saves all settings
story: OCD-16
epic: OCD-2
project: oap-cloud
projectKey: OCD
projectKey: OCD
path: .projects/oap-cloud/OCD-2/OCD-16/OCD-54.toon
