id: OCD-62
type: task
parent: OCD-20
title: "Build Blog backend (model, migration, controller, seeder)"
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 30
estimate_tokens: null
description: "Create the blog post backend with model, migration, controller, and factory/seeder.\n\n**Steps:**\n\n1. `cd src/platform && php artisan make:model Post -mfc`\n\n2. Edit `src/platform/database/migrations/*_create_posts_table.php`:\n```php\nSchema::create('posts', function (Blueprint $table) {\n    $table->id();\n    $table->foreignId('user_id')->constrained()->cascadeOnDelete();\n    $table->string('title');\n    $table->string('slug')->unique();\n    $table->text('excerpt')->nullable();\n    $table->longText('body'); // markdown content\n    $table->string('featured_image')->nullable();\n    $table->string('meta_title')->nullable();\n    $table->string('meta_description')->nullable();\n    $table->boolean('is_published')->default(false);\n    $table->timestamp('published_at')->nullable();\n    $table->timestamps();\n    $table->index(['is_published', 'published_at']);\n});\n\nSchema::create('categories', function (Blueprint $table) {\n    $table->id();\n    $table->string('name');\n    $table->string('slug')->unique();\n    $table->timestamps();\n});\n\nSchema::create('tags', function (Blueprint $table) {\n    $table->id();\n    $table->string('name');\n    $table->string('slug')->unique();\n    $table->timestamps();\n});\n\nSchema::create('category_post', function (Blueprint $table) {\n    $table->foreignId('category_id')->constrained()->cascadeOnDelete();\n    $table->foreignId('post_id')->constrained()->cascadeOnDelete();\n    $table->primary(['category_id', 'post_id']);\n});\n\nSchema::create('post_tag', function (Blueprint $table) {\n    $table->foreignId('post_id')->constrained()->cascadeOnDelete();\n    $table->foreignId('tag_id')->constrained()->cascadeOnDelete();\n    $table->primary(['post_id', 'tag_id']);\n});\n```\n\n3. Create models:\n`php artisan make:model Category`\n`php artisan make:model Tag`\n\nEdit `src/platform/app/Models/Post.php`:\n```php\n<?php\nnamespace App\\Models;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\nuse Illuminate\\Support\\Str;\n\nclass Post extends Model\n{\n    use HasFactory;\n\n    protected $fillable = [\n        'user_id', 'title', 'slug', 'excerpt', 'body',\n        'featured_image', 'meta_title', 'meta_description',\n        'is_published', 'published_at',\n    ];\n\n    protected $casts = [\n        'is_published' => 'boolean',\n        'published_at' => 'datetime',\n    ];\n\n    protected static function booted(): void\n    {\n        static::creating(function (Post $post) {\n            if (empty($post->slug)) {\n                $post->slug = Str::slug($post->title);\n            }\n        });\n    }\n\n    public function author(): BelongsTo { return $this->belongsTo(User::class, 'user_id'); }\n    public function categories(): BelongsToMany { return $this->belongsToMany(Category::class); }\n    public function tags(): BelongsToMany { return $this->belongsToMany(Tag::class); }\n\n    public function scopePublished($query) {\n        return $query->where('is_published', true)->where('published_at', '<=', now());\n    }\n}\n```\n\nEdit `src/platform/app/Models/Category.php`:\n```php\n<?php\nnamespace App\\Models;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n\nclass Category extends Model\n{\n    protected $fillable = ['name', 'slug'];\n    public function posts(): BelongsToMany { return $this->belongsToMany(Post::class); }\n}\n```\n\nEdit `src/platform/app/Models/Tag.php`:\n```php\n<?php\nnamespace App\\Models;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n\nclass Tag extends Model\n{\n    protected $fillable = ['name', 'slug'];\n    public function posts(): BelongsToMany { return $this->belongsToMany(Post::class); }\n}\n```\n\n4. Create controller: `php artisan make:controller BlogController`\nEdit `src/platform/app/Http/Controllers/BlogController.php`:\n```php\n<?php\nnamespace App\\Http\\Controllers;\n\nuse App\\Models\\Category;\nuse App\\Models\\Post;\nuse App\\Models\\Tag;\nuse Illuminate\\Http\\Request;\nuse Inertia\\Inertia;\n\nclass BlogController extends Controller\n{\n    public function index(Request $request)\n    {\n        $query = Post::published()->with(['author:id,name', 'categories:id,name,slug', 'tags:id,name,slug']);\n\n        if ($request->has('category')) {\n            $query->whereHas('categories', fn ($q) => $q->where('slug', $request->category));\n        }\n        if ($request->has('tag')) {\n            $query->whereHas('tags', fn ($q) => $q->where('slug', $request->tag));\n        }\n\n        return Inertia::render('Blog/Index', [\n            'posts' => $query->orderByDesc('published_at')->paginate(12)->through(fn ($post) => [\n                'id' => $post->id,\n                'title' => $post->title,\n                'slug' => $post->slug,\n                'excerpt' => $post->excerpt,\n                'featured_image' => $post->featured_image,\n                'published_at' => $post->published_at->format('M d, Y'),\n                'author' => $post->author->name,\n                'categories' => $post->categories->pluck('name'),\n            ]),\n            'categories' => Category::withCount('posts')->get(),\n            'currentCategory' => $request->category,\n            'currentTag' => $request->tag,\n        ]);\n    }\n\n    public function show(string $slug)\n    {\n        $post = Post::published()->where('slug', $slug)->with(['author:id,name', 'categories', 'tags'])->firstOrFail();\n        return Inertia::render('Blog/Show', [\n            'post' => [\n                'id' => $post->id,\n                'title' => $post->title,\n                'slug' => $post->slug,\n                'body' => $post->body, // markdown - rendered on frontend\n                'featured_image' => $post->featured_image,\n                'published_at' => $post->published_at->format('M d, Y'),\n                'author' => $post->author->name,\n                'categories' => $post->categories,\n                'tags' => $post->tags,\n                'meta_title' => $post->meta_title ?? $post->title,\n                'meta_description' => $post->meta_description ?? $post->excerpt,\n            ],\n        ]);\n    }\n\n    public function feed()\n    {\n        $posts = Post::published()->orderByDesc('published_at')->limit(20)->get();\n        return response()->view('blog.feed', ['posts' => $posts])\n            ->header('Content-Type', 'application/rss+xml');\n    }\n}\n```\n\n5. Create RSS feed Blade view at `src/platform/resources/views/blog/feed.blade.php`:\n```blade\n{!! '<'.'?xml version=\"1.0\" encoding=\"UTF-8\"?>' !!}\n<rss version=\"2.0\">\n    <channel>\n        <title>{{ config('app.name') }} Blog</title>\n        <link>{{ url('/blog') }}</link>\n        <description>Latest updates from {{ config('app.name') }}</description>\n        @foreach($posts as $post)\n        <item>\n            <title>{{ $post->title }}</title>\n            <link>{{ url(\"/blog/{$post->slug}\") }}</link>\n            <description>{{ $post->excerpt }}</description>\n            <pubDate>{{ $post->published_at->toRssString() }}</pubDate>\n        </item>\n        @endforeach\n    </channel>\n</rss>\n```\n\n6. Add routes:\n```php\nRoute::get('/blog', [BlogController::class, 'index'])->name('blog.index');\nRoute::get('/blog/{slug}', [BlogController::class, 'show'])->name('blog.show');\nRoute::get('/feed', [BlogController::class, 'feed'])->name('blog.feed');\n```\n\n7. Create factory and seeder for sample posts.\n\n**File paths:**\n- `src/platform/database/migrations/*_create_posts_table.php`\n- `src/platform/app/Models/Post.php`\n- `src/platform/app/Models/Category.php`\n- `src/platform/app/Models/Tag.php`\n- `src/platform/app/Http/Controllers/BlogController.php`\n- `src/platform/resources/views/blog/feed.blade.php`\n- `src/platform/routes/web.php` (updated)\n- `src/platform/database/factories/PostFactory.php`"
acceptance_criteria[9]: "posts table with title, slug, excerpt, body, featured_image, meta fields, is_published, published_at",categories and tags tables with many-to-many pivot tables,"Post model with author, categories, tags relationships",Post model auto-generates slug from title,Post published scope filters by is_published and published_at,"BlogController index with pagination, category/tag filtering",BlogController show fetches single post by slug,RSS feed at /feed returns valid XML with latest 20 posts,"Routes registered for /blog, /blog/{slug}, /feed"
story: OCD-20
epic: OCD-3
project: oap-cloud
projectKey: OCD
projectKey: OCD
path: .projects/oap-cloud/OCD-3/OCD-20/OCD-62.toon
