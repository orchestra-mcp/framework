id: OMB-39
type: task
parent: OMB-31
title: "Build AI agent control screens (status, chat, permissions)"
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 65
estimate_tokens: null
description: "Create the AI agent management screens for monitoring and controlling agents from mobile.\n\n1. Create `src/mobile/src/services/agentService.ts`:\n   ```typescript\n   import { apiClient } from './apiClient';\n\n   export interface Agent {\n     id: string;\n     name: string;\n     status: 'running' | 'idle' | 'waiting' | 'error' | 'offline';\n     current_task: string | null;\n     model: string;\n     uptime_minutes: number;\n     pending_permissions: number;\n   }\n\n   export interface AgentMessage {\n     id: string;\n     role: 'user' | 'agent' | 'system';\n     content: string;\n     timestamp: string;\n   }\n\n   export interface AgentPermission {\n     id: string;\n     agent_id: string;\n     type: 'file_write' | 'file_delete' | 'command_execute' | 'network_request' | 'git_push';\n     description: string;\n     context: string;\n     requested_at: string;\n     status: 'pending' | 'approved' | 'denied';\n   }\n\n   export const agentService = {\n     async getAgents(): Promise<Agent[]> {\n       const response = await apiClient.get<{ data: Agent[] }>('/agents');\n       return response.data.data;\n     },\n\n     async getAgent(agentId: string): Promise<Agent> {\n       const response = await apiClient.get<{ data: Agent }>(`/agents/${agentId}`);\n       return response.data.data;\n     },\n\n     async getMessages(agentId: string): Promise<AgentMessage[]> {\n       const response = await apiClient.get<{ data: AgentMessage[] }>(`/agents/${agentId}/messages`);\n       return response.data.data;\n     },\n\n     async sendPrompt(agentId: string, prompt: string): Promise<AgentMessage> {\n       const response = await apiClient.post<{ data: AgentMessage }>(`/agents/${agentId}/prompt`, { prompt });\n       return response.data.data;\n     },\n\n     async getPermissions(agentId: string): Promise<AgentPermission[]> {\n       const response = await apiClient.get<{ data: AgentPermission[] }>(`/agents/${agentId}/permissions`);\n       return response.data.data;\n     },\n\n     async respondToPermission(agentId: string, permissionId: string, action: 'approve' | 'deny'): Promise<void> {\n       await apiClient.post(`/agents/${agentId}/permissions/${permissionId}/respond`, { action });\n     },\n   };\n   ```\n\n2. Create `src/mobile/src/stores/agentStore.ts`:\n   ```typescript\n   import { create } from 'zustand';\n   import { agentService, Agent, AgentMessage, AgentPermission } from '@services/agentService';\n\n   interface AgentState {\n     agents: Agent[];\n     currentAgent: Agent | null;\n     messages: AgentMessage[];\n     permissions: AgentPermission[];\n     isLoading: boolean;\n     isSending: boolean;\n     error: string | null;\n     fetchAgents: () => Promise<void>;\n     fetchAgent: (agentId: string) => Promise<void>;\n     fetchMessages: (agentId: string) => Promise<void>;\n     sendPrompt: (agentId: string, prompt: string) => Promise<void>;\n     fetchPermissions: (agentId: string) => Promise<void>;\n     respondToPermission: (agentId: string, permissionId: string, action: 'approve' | 'deny') => Promise<void>;\n     addMessage: (message: AgentMessage) => void; // For WebSocket real-time updates\n     updateAgentStatus: (agentId: string, status: Agent['status']) => void; // For WebSocket\n   }\n\n   export const useAgentStore = create<AgentState>((set, get) => ({\n     agents: [],\n     currentAgent: null,\n     messages: [],\n     permissions: [],\n     isLoading: false,\n     isSending: false,\n     error: null,\n\n     fetchAgents: async () => {\n       set({ isLoading: true });\n       try {\n         const agents = await agentService.getAgents();\n         set({ agents, isLoading: false });\n       } catch (error: any) {\n         set({ error: error.message, isLoading: false });\n       }\n     },\n\n     fetchAgent: async (agentId) => {\n       try {\n         const currentAgent = await agentService.getAgent(agentId);\n         set({ currentAgent });\n       } catch (error: any) {\n         set({ error: error.message });\n       }\n     },\n\n     fetchMessages: async (agentId) => {\n       set({ isLoading: true });\n       try {\n         const messages = await agentService.getMessages(agentId);\n         set({ messages, isLoading: false });\n       } catch (error: any) {\n         set({ error: error.message, isLoading: false });\n       }\n     },\n\n     sendPrompt: async (agentId, prompt) => {\n       const optimisticMsg: AgentMessage = {\n         id: `temp-${Date.now()}`,\n         role: 'user',\n         content: prompt,\n         timestamp: new Date().toISOString(),\n       };\n       set((state) => ({ messages: [...state.messages, optimisticMsg], isSending: true }));\n       try {\n         const response = await agentService.sendPrompt(agentId, prompt);\n         set((state) => ({\n           messages: state.messages.map((m) => (m.id === optimisticMsg.id ? response : m)),\n           isSending: false,\n         }));\n       } catch (error: any) {\n         set((state) => ({\n           messages: state.messages.filter((m) => m.id !== optimisticMsg.id),\n           isSending: false,\n           error: error.message,\n         }));\n       }\n     },\n\n     fetchPermissions: async (agentId) => {\n       try {\n         const permissions = await agentService.getPermissions(agentId);\n         set({ permissions });\n       } catch (error: any) {\n         set({ error: error.message });\n       }\n     },\n\n     respondToPermission: async (agentId, permissionId, action) => {\n       try {\n         await agentService.respondToPermission(agentId, permissionId, action);\n         set((state) => ({\n           permissions: state.permissions.filter((p) => p.id !== permissionId),\n         }));\n       } catch (error: any) {\n         set({ error: error.message });\n       }\n     },\n\n     addMessage: (message) => {\n       set((state) => ({ messages: [...state.messages, message] }));\n     },\n\n     updateAgentStatus: (agentId, status) => {\n       set((state) => ({\n         agents: state.agents.map((a) => (a.id === agentId ? { ...a, status } : a)),\n         currentAgent: state.currentAgent?.id === agentId\n           ? { ...state.currentAgent, status }\n           : state.currentAgent,\n       }));\n     },\n   }));\n   ```\n\n3. Create `src/mobile/src/app/agent/AgentHomeScreen.tsx`:\n   - FlatList of agents, each showing: name, status indicator (colored dot: running=green, idle=gray, waiting=amber, error=red), model name, current task, pending permissions badge\n   - Tapping an agent navigates to AgentChat\n   - If agent has pending_permissions > 0, show a \"Needs Attention\" badge\n\n4. Create `src/mobile/src/app/agent/AgentChatScreen.tsx`:\n   - Chat-style UI with FlatList (inverted) showing messages\n   - User messages right-aligned (blue bubble), agent messages left-aligned (gray bubble), system messages centered (small text)\n   - Text input at bottom with send button\n   - Agent status bar at top showing agent name + status dot\n   - Button to navigate to AgentPermissions\n   - Auto-scroll to newest message\n\n5. Create `src/mobile/src/app/agent/AgentPermissionsScreen.tsx`:\n   - List of pending permissions, each showing: type icon, description, context preview, requested time\n   - Each item has Approve (green) and Deny (red) buttons\n   - Type icons: file_write=document, file_delete=trash, command_execute=terminal, network_request=globe, git_push=git-branch\n   - After approve/deny, item animates out of list\n\n6. Register all screens in AgentNavigator. Export from `src/mobile/src/app/agent/index.ts`.\n\n7. Verify: Agent list shows with real-time status, chat sends prompts optimistically, permissions can be approved/denied."
acceptance_criteria[10]: "agentService.ts has getAgents, getAgent, getMessages, sendPrompt, getPermissions, respondToPermission","agentStore.ts manages agents, messages, permissions with real-time update methods (addMessage, updateAgentStatus)","AgentHomeScreen shows agent list with name, status dot, model, pending permissions badge",AgentChatScreen has chat UI with user/agent/system message bubbles and text input,"sendPrompt adds optimistic message, replaces with server response on success",AgentPermissionsScreen lists pending permissions with approve/deny buttons for each,"Permission response calls POST /api/agents/:id/permissions/:permId/respond",Approved/denied permissions are removed from the list,All screens registered in AgentNavigator,"Status indicator colors: running=green, idle=gray, waiting=amber, error=red, offline=gray"
story: OMB-31
epic: OMB-3
project: oap-mobile
projectKey: OMB
path: .projects/oap-mobile/OMB-3/OMB-31/OMB-39.toon
