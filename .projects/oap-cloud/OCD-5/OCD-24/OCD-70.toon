id: OCD-70
type: task
parent: OCD-24
title: "Create dashboard data models and migrations (TaskEntry, TimeEntry, CommitEntry)"
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 25
estimate_tokens: null
description: "Create the database models that store synced data from the IDE for the dashboard widgets.\n\n**Steps:**\n\n1. `cd src/platform`\n2. Create models and migrations:\n```bash\nphp artisan make:model TaskEntry -mf\nphp artisan make:model TimeEntry -mf\nphp artisan make:model CommitEntry -mf\n```\n\n3. Edit `src/platform/database/migrations/*_create_task_entries_table.php`:\n```php\nSchema::create('task_entries', function (Blueprint $table) {\n    $table->id();\n    $table->foreignId('user_id')->constrained()->cascadeOnDelete();\n    $table->foreignId('team_id')->constrained()->cascadeOnDelete();\n    $table->string('project_name');\n    $table->string('epic_name')->nullable();\n    $table->string('story_name')->nullable();\n    $table->string('task_title');\n    $table->string('task_key')->nullable(); // e.g., OCD-42\n    $table->longText('description')->nullable(); // markdown\n    $table->enum('status', ['backlog', 'in_progress', 'review', 'done'])->default('backlog');\n    $table->enum('priority', ['low', 'medium', 'high'])->default('medium');\n    $table->string('external_id')->nullable(); // IDE sync ID\n    $table->string('external_source')->nullable(); // 'ide', 'jira', 'linear', 'github'\n    $table->timestamps();\n    $table->index(['user_id', 'team_id', 'status']);\n    $table->index('external_id');\n});\n```\n\n4. Edit `src/platform/database/migrations/*_create_time_entries_table.php`:\n```php\nSchema::create('time_entries', function (Blueprint $table) {\n    $table->id();\n    $table->foreignId('user_id')->constrained()->cascadeOnDelete();\n    $table->foreignId('team_id')->constrained()->cascadeOnDelete();\n    $table->foreignId('task_entry_id')->nullable()->constrained()->nullOnDelete();\n    $table->enum('type', ['timer', 'break', 'pomodoro'])->default('timer');\n    $table->string('label')->nullable();\n    $table->timestamp('started_at');\n    $table->timestamp('ended_at')->nullable();\n    $table->integer('duration_seconds')->default(0);\n    $table->string('external_id')->nullable();\n    $table->timestamps();\n    $table->index(['user_id', 'type', 'started_at']);\n});\n```\n\n5. Edit `src/platform/database/migrations/*_create_commit_entries_table.php`:\n```php\nSchema::create('commit_entries', function (Blueprint $table) {\n    $table->id();\n    $table->foreignId('user_id')->constrained()->cascadeOnDelete();\n    $table->foreignId('team_id')->constrained()->cascadeOnDelete();\n    $table->string('sha', 40);\n    $table->text('message');\n    $table->string('branch')->nullable();\n    $table->string('repo_name');\n    $table->string('repo_provider')->default('github'); // github, gitlab, bitbucket\n    $table->integer('additions')->default(0);\n    $table->integer('deletions')->default(0);\n    $table->timestamp('committed_at');\n    $table->string('external_id')->nullable();\n    $table->timestamps();\n    $table->index(['user_id', 'committed_at']);\n    $table->unique('sha');\n});\n```\n\n6. Edit models with relationships and scopes:\n\n`src/platform/app/Models/TaskEntry.php`:\n```php\n<?php\nnamespace App\\Models;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n\nclass TaskEntry extends Model\n{\n    use HasFactory;\n    protected $fillable = ['user_id', 'team_id', 'project_name', 'epic_name', 'story_name', 'task_title', 'task_key', 'description', 'status', 'priority', 'external_id', 'external_source'];\n\n    public function user(): BelongsTo { return $this->belongsTo(User::class); }\n    public function team(): BelongsTo { return $this->belongsTo(Team::class); }\n    public function timeEntries(): HasMany { return $this->hasMany(TimeEntry::class); }\n\n    public function scopeForUser($q, int $userId) { return $q->where('user_id', $userId); }\n    public function scopeForTeam($q, int $teamId) { return $q->where('team_id', $teamId); }\n    public function scopeCompletedThisWeek($q) {\n        return $q->where('status', 'done')->whereBetween('updated_at', [now()->startOfWeek(), now()->endOfWeek()]);\n    }\n}\n```\n\n`src/platform/app/Models/TimeEntry.php`:\n```php\n<?php\nnamespace App\\Models;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n\nclass TimeEntry extends Model\n{\n    use HasFactory;\n    protected $fillable = ['user_id', 'team_id', 'task_entry_id', 'type', 'label', 'started_at', 'ended_at', 'duration_seconds', 'external_id'];\n    protected $casts = ['started_at' => 'datetime', 'ended_at' => 'datetime'];\n\n    public function user(): BelongsTo { return $this->belongsTo(User::class); }\n    public function team(): BelongsTo { return $this->belongsTo(Team::class); }\n    public function taskEntry(): BelongsTo { return $this->belongsTo(TaskEntry::class); }\n\n    public function scopeThisWeek($q) { return $q->whereBetween('started_at', [now()->startOfWeek(), now()->endOfWeek()]); }\n    public function scopeTimers($q) { return $q->where('type', 'timer'); }\n    public function scopeBreaks($q) { return $q->where('type', 'break'); }\n    public function scopePomodoros($q) { return $q->where('type', 'pomodoro'); }\n}\n```\n\n`src/platform/app/Models/CommitEntry.php`:\n```php\n<?php\nnamespace App\\Models;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n\nclass CommitEntry extends Model\n{\n    use HasFactory;\n    protected $fillable = ['user_id', 'team_id', 'sha', 'message', 'branch', 'repo_name', 'repo_provider', 'additions', 'deletions', 'committed_at', 'external_id'];\n    protected $casts = ['committed_at' => 'datetime'];\n\n    public function user(): BelongsTo { return $this->belongsTo(User::class); }\n    public function team(): BelongsTo { return $this->belongsTo(Team::class); }\n\n    public function scopeThisWeek($q) { return $q->whereBetween('committed_at', [now()->startOfWeek(), now()->endOfWeek()]); }\n}\n```\n\n7. Run `php artisan migrate`\n\n**File paths:**\n- `src/platform/database/migrations/*_create_task_entries_table.php`\n- `src/platform/database/migrations/*_create_time_entries_table.php`\n- `src/platform/database/migrations/*_create_commit_entries_table.php`\n- `src/platform/app/Models/TaskEntry.php`\n- `src/platform/app/Models/TimeEntry.php`\n- `src/platform/app/Models/CommitEntry.php`"
acceptance_criteria[9]: "task_entries table with user_id, team_id, project/epic/story/task fields, status, priority, external sync fields","time_entries table with user_id, team_id, task reference, type (timer/break/pomodoro), duration","commit_entries table with user_id, team_id, sha, message, branch, repo info, additions/deletions",All models have user and team relationships,TaskEntry has completedThisWeek scope,"TimeEntry has thisWeek, timers, breaks, pomodoros scopes",CommitEntry has thisWeek scope,All migrations run successfully,Factories created for each model
story: OCD-24
epic: OCD-5
project: oap-cloud
projectKey: OCD
path: .projects/oap-cloud/OCD-5/OCD-24/OCD-70.toon
