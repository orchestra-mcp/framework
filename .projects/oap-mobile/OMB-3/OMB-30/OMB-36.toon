id: OMB-36
type: task
parent: OMB-30
title: "Build timer API service, store, and TimerHomeScreen with start/stop controls"
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 55
estimate_tokens: null
description: "Create the timer service, Zustand store, and the main timer screen with start/stop/break/pomodoro controls.\n\n1. Create `src/mobile/src/services/timerService.ts`:\n   ```typescript\n   import { apiClient } from './apiClient';\n\n   export interface TimerEntry {\n     id: number;\n     task_id: string | null;\n     task_name: string | null;\n     type: 'work' | 'break' | 'pomodoro';\n     started_at: string;\n     stopped_at: string | null;\n     duration_minutes: number | null;\n   }\n\n   export interface ActiveTimer {\n     id: number;\n     task_id: string | null;\n     task_name: string | null;\n     type: 'work' | 'break' | 'pomodoro';\n     started_at: string;\n     elapsed_seconds: number;\n   }\n\n   export interface TimerReport {\n     period: 'daily' | 'weekly' | 'monthly';\n     total_minutes: number;\n     work_minutes: number;\n     break_minutes: number;\n     labels: string[];\n     data: number[]; // minutes per label (day/week/month)\n     entries: TimerEntry[];\n   }\n\n   export const timerService = {\n     async getCurrent(): Promise<ActiveTimer | null> {\n       const response = await apiClient.get<{ data: ActiveTimer | null }>('/timers/current');\n       return response.data.data;\n     },\n\n     async start(taskId?: string, type: 'work' | 'break' | 'pomodoro' = 'work'): Promise<ActiveTimer> {\n       const response = await apiClient.post<{ data: ActiveTimer }>('/timers/start', {\n         task_id: taskId,\n         type,\n       });\n       return response.data.data;\n     },\n\n     async stop(): Promise<TimerEntry> {\n       const response = await apiClient.post<{ data: TimerEntry }>('/timers/stop');\n       return response.data.data;\n     },\n\n     async getReport(period: 'daily' | 'weekly' | 'monthly'): Promise<TimerReport> {\n       const response = await apiClient.get<{ data: TimerReport }>('/timers/reports', {\n         params: { period },\n       });\n       return response.data.data;\n     },\n   };\n   ```\n\n2. Create `src/mobile/src/stores/timerStore.ts`:\n   ```typescript\n   import { create } from 'zustand';\n   import { timerService, ActiveTimer, TimerReport } from '@services/timerService';\n\n   interface PomodoroSettings {\n     workMinutes: number;\n     shortBreakMinutes: number;\n     longBreakMinutes: number;\n     sessionsBeforeLongBreak: number;\n   }\n\n   interface TimerState {\n     activeTimer: ActiveTimer | null;\n     elapsedSeconds: number;\n     isRunning: boolean;\n     pomodoroSettings: PomodoroSettings;\n     pomodoroSession: number;\n     report: TimerReport | null;\n     isLoading: boolean;\n     error: string | null;\n     fetchCurrent: () => Promise<void>;\n     startTimer: (taskId?: string, type?: 'work' | 'break' | 'pomodoro') => Promise<void>;\n     stopTimer: () => Promise<void>;\n     tick: () => void;\n     fetchReport: (period: 'daily' | 'weekly' | 'monthly') => Promise<void>;\n     setPomodoroSettings: (settings: Partial<PomodoroSettings>) => void;\n     incrementPomodoroSession: () => void;\n   }\n\n   export const useTimerStore = create<TimerState>((set, get) => ({\n     activeTimer: null,\n     elapsedSeconds: 0,\n     isRunning: false,\n     pomodoroSettings: {\n       workMinutes: 25,\n       shortBreakMinutes: 5,\n       longBreakMinutes: 15,\n       sessionsBeforeLongBreak: 4,\n     },\n     pomodoroSession: 0,\n     report: null,\n     isLoading: false,\n     error: null,\n\n     fetchCurrent: async () => {\n       try {\n         const activeTimer = await timerService.getCurrent();\n         if (activeTimer) {\n           set({\n             activeTimer,\n             elapsedSeconds: activeTimer.elapsed_seconds,\n             isRunning: true,\n           });\n         } else {\n           set({ activeTimer: null, elapsedSeconds: 0, isRunning: false });\n         }\n       } catch (error: any) {\n         set({ error: error.message });\n       }\n     },\n\n     startTimer: async (taskId, type = 'work') => {\n       set({ isLoading: true });\n       try {\n         const activeTimer = await timerService.start(taskId, type);\n         set({\n           activeTimer,\n           elapsedSeconds: 0,\n           isRunning: true,\n           isLoading: false,\n         });\n       } catch (error: any) {\n         set({ error: error.message, isLoading: false });\n       }\n     },\n\n     stopTimer: async () => {\n       set({ isLoading: true });\n       try {\n         await timerService.stop();\n         set({\n           activeTimer: null,\n           elapsedSeconds: 0,\n           isRunning: false,\n           isLoading: false,\n         });\n       } catch (error: any) {\n         set({ error: error.message, isLoading: false });\n       }\n     },\n\n     tick: () => {\n       set((state) => ({ elapsedSeconds: state.elapsedSeconds + 1 }));\n     },\n\n     fetchReport: async (period) => {\n       set({ isLoading: true, error: null });\n       try {\n         const report = await timerService.getReport(period);\n         set({ report, isLoading: false });\n       } catch (error: any) {\n         set({ error: error.message, isLoading: false });\n       }\n     },\n\n     setPomodoroSettings: (settings) => {\n       set((state) => ({\n         pomodoroSettings: { ...state.pomodoroSettings, ...settings },\n       }));\n     },\n\n     incrementPomodoroSession: () => {\n       set((state) => ({ pomodoroSession: state.pomodoroSession + 1 }));\n     },\n   }));\n   ```\n\n3. Create `src/mobile/src/app/timers/TimerHomeScreen.tsx`:\n   ```typescript\n   import React, { useEffect, useRef } from 'react';\n   import { View, Text, TouchableOpacity, AppState, AppStateStatus } from 'react-native';\n   import Icon from 'react-native-vector-icons/Ionicons';\n   import { useTimerStore } from '@stores/timerStore';\n\n   export const TimerHomeScreen: React.FC = () => {\n     const {\n       activeTimer, elapsedSeconds, isRunning, isLoading,\n       pomodoroSettings, pomodoroSession,\n       fetchCurrent, startTimer, stopTimer, tick,\n     } = useTimerStore();\n     const intervalRef = useRef<ReturnType<typeof setInterval> | null>(null);\n\n     // Fetch current timer on mount\n     useEffect(() => {\n       fetchCurrent();\n     }, []);\n\n     // Tick every second when running\n     useEffect(() => {\n       if (isRunning) {\n         intervalRef.current = setInterval(tick, 1000);\n       } else if (intervalRef.current) {\n         clearInterval(intervalRef.current);\n       }\n       return () => {\n         if (intervalRef.current) clearInterval(intervalRef.current);\n       };\n     }, [isRunning]);\n\n     // Handle app background/foreground - recalculate elapsed on foreground\n     useEffect(() => {\n       const handleAppState = (state: AppStateStatus) => {\n         if (state === 'active' && isRunning) {\n           fetchCurrent(); // Re-sync with server\n         }\n       };\n       const subscription = AppState.addEventListener('change', handleAppState);\n       return () => subscription.remove();\n     }, [isRunning]);\n\n     const formatTime = (totalSeconds: number): string => {\n       const h = Math.floor(totalSeconds / 3600);\n       const m = Math.floor((totalSeconds % 3600) / 60);\n       const s = totalSeconds % 60;\n       return h > 0\n         ? `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`\n         : `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;\n     };\n\n     // Render layout:\n     // 1. Large circular timer display showing elapsed time\n     // 2. Timer type indicator (Work / Break / Pomodoro)\n     // 3. Task name if associated with a task\n     // 4. Large start/stop button (green circle for start, red for stop)\n     // 5. Three mode buttons below: Work, Break, Pomodoro\n     // 6. Pomodoro session counter (e.g., \"Session 2 of 4\")\n     // 7. Navigation to Report and Pomodoro Settings\n   };\n   ```\n\n   The screen must:\n   - Show a large formatted time display (HH:MM:SS or MM:SS)\n   - Have a prominent circular start/stop button (green play icon / red stop icon)\n   - Show 3 mode selection buttons: Work (blue), Break (green), Pomodoro (purple)\n   - When in Pomodoro mode, show session count (\"Session 2/4\") and auto-transition between work/break\n   - Re-sync elapsed time with server when app returns to foreground (AppState listener)\n   - Persist timer across app backgrounding (server tracks real time)\n\n4. Register in TimersNavigator. Export from `src/mobile/src/app/timers/index.ts`.\n\n5. Verify: Timer starts/stops via API, elapsed time ticks every second, app foreground re-syncs with server."
acceptance_criteria[10]: "timerService.ts has getCurrent, start, stop, getReport methods with correct API endpoints","timerStore.ts manages activeTimer, elapsedSeconds, isRunning, pomodoroSettings, and report state","TimerHomeScreen.tsx displays large time counter formatted as MM:SS or HH:MM:SS","Start button calls startTimer(), stop button calls stopTimer()",Timer ticks every second via setInterval when isRunning is true,AppState listener re-syncs timer with server when app returns to foreground,"Three mode buttons available: Work, Break, Pomodoro",Pomodoro session counter shows current session number,Loading state disables buttons during API calls,Timer data fetched from server on screen mount
story: OMB-30
epic: OMB-3
project: oap-mobile
projectKey: OMB
path: .projects/oap-mobile/OMB-3/OMB-30/OMB-36.toon
