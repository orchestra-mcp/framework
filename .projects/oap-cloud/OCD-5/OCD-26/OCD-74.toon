id: OCD-74
type: task
parent: OCD-26
title: Build Timer/Break/Pomodoro reports page with charts and filters
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 30
estimate_tokens: null
description: "Create the timers dashboard page showing time tracking, break, and pomodoro reports.\n\n**Steps:**\n\n1. Create controller: `cd src/platform && php artisan make:controller Dashboard/TimersController`\nEdit `src/platform/app/Http/Controllers/Dashboard/TimersController.php`:\n```php\n<?php\nnamespace App\\Http\\Controllers\\Dashboard;\n\nuse App\\Http\\Controllers\\Controller;\nuse App\\Models\\TimeEntry;\nuse Illuminate\\Http\\Request;\nuse Inertia\\Inertia;\nuse Carbon\\Carbon;\n\nclass TimersController extends Controller\n{\n    public function index(Request $request)\n    {\n        $user = $request->user();\n        $startDate = $request->filled('from') ? Carbon::parse($request->from) : now()->startOfWeek();\n        $endDate = $request->filled('to') ? Carbon::parse($request->to) : now()->endOfWeek();\n\n        $entries = TimeEntry::where('user_id', $user->id)\n            ->whereBetween('started_at', [$startDate, $endDate])\n            ->with('taskEntry:id,task_title,project_name')\n            ->orderByDesc('started_at')\n            ->get();\n\n        return Inertia::render('Dashboard/Timers', [\n            'entries' => $entries->map(fn ($e) => [\n                'id' => $e->id,\n                'type' => $e->type,\n                'label' => $e->label,\n                'task' => $e->taskEntry?->task_title,\n                'project' => $e->taskEntry?->project_name,\n                'started_at' => $e->started_at->format('Y-m-d H:i'),\n                'ended_at' => $e->ended_at?->format('Y-m-d H:i'),\n                'duration_seconds' => $e->duration_seconds,\n            ]),\n            'summary' => [\n                'total_timer' => $entries->where('type', 'timer')->sum('duration_seconds'),\n                'total_break' => $entries->where('type', 'break')->sum('duration_seconds'),\n                'total_pomodoro' => $entries->where('type', 'pomodoro')->sum('duration_seconds'),\n                'session_count' => $entries->count(),\n                'pomodoro_count' => $entries->where('type', 'pomodoro')->count(),\n            ],\n            'dailyBreakdown' => $this->getDailyBreakdown($user->id, $startDate, $endDate),\n            'perProjectTime' => $this->getPerProjectTime($user->id, $startDate, $endDate),\n            'filters' => [\n                'from' => $startDate->format('Y-m-d'),\n                'to' => $endDate->format('Y-m-d'),\n            ],\n        ]);\n    }\n\n    private function getDailyBreakdown(int $userId, Carbon $from, Carbon $to): array\n    {\n        $data = [];\n        $current = $from->copy();\n        while ($current->lte($to)) {\n            $dayEntries = TimeEntry::where('user_id', $userId)->whereDate('started_at', $current);\n            $data[] = [\n                'date' => $current->format('D M d'),\n                'timer' => round($dayEntries->clone()->timers()->sum('duration_seconds') / 3600, 1),\n                'break' => round($dayEntries->clone()->breaks()->sum('duration_seconds') / 3600, 1),\n                'pomodoro' => round($dayEntries->clone()->pomodoros()->sum('duration_seconds') / 3600, 1),\n            ];\n            $current->addDay();\n        }\n        return $data;\n    }\n\n    private function getPerProjectTime(int $userId, Carbon $from, Carbon $to): array\n    {\n        return TimeEntry::where('user_id', $userId)\n            ->timers()\n            ->whereBetween('started_at', [$from, $to])\n            ->whereNotNull('task_entry_id')\n            ->join('task_entries', 'time_entries.task_entry_id', '=', 'task_entries.id')\n            ->selectRaw('task_entries.project_name, SUM(time_entries.duration_seconds) as total_seconds')\n            ->groupBy('task_entries.project_name')\n            ->get()\n            ->map(fn ($row) => ['project' => $row->project_name, 'hours' => round($row->total_seconds / 3600, 1)])\n            ->toArray();\n    }\n\n    public function export(Request $request)\n    {\n        // CSV export of time entries\n        $user = $request->user();\n        $startDate = $request->filled('from') ? Carbon::parse($request->from) : now()->startOfMonth();\n        $endDate = $request->filled('to') ? Carbon::parse($request->to) : now();\n\n        $entries = TimeEntry::where('user_id', $user->id)\n            ->whereBetween('started_at', [$startDate, $endDate])\n            ->with('taskEntry:id,task_title,project_name')\n            ->orderByDesc('started_at')\n            ->get();\n\n        $csv = \"Type,Label,Task,Project,Started,Ended,Duration (min)\\n\";\n        foreach ($entries as $e) {\n            $csv .= implode(',', [\n                $e->type, $e->label ?? '', $e->taskEntry?->task_title ?? '',\n                $e->taskEntry?->project_name ?? '', $e->started_at, $e->ended_at ?? '',\n                round($e->duration_seconds / 60, 1),\n            ]) . \"\\n\";\n        }\n\n        return response($csv, 200, [\n            'Content-Type' => 'text/csv',\n            'Content-Disposition' => \"attachment; filename=time-report-{$startDate->format('Y-m-d')}-to-{$endDate->format('Y-m-d')}.csv\",\n        ]);\n    }\n}\n```\n\n2. Create `src/platform/resources/js/Pages/Dashboard/Timers.tsx` with:\n- Summary cards (total time, breaks, pomodoro count)\n- Date range filter\n- Daily breakdown stacked bar chart (timer/break/pomodoro hours per day)\n- Per-project time pie/bar chart\n- Entry log table\n- Export CSV/PDF buttons\n\n3. Add routes:\n```php\nRoute::get('/dashboard/timers', [TimersController::class, 'index'])->name('dashboard.timers');\nRoute::get('/dashboard/timers/export', [TimersController::class, 'export'])->name('dashboard.timers.export');\n```\n\n**File paths:**\n- `src/platform/app/Http/Controllers/Dashboard/TimersController.php`\n- `src/platform/resources/js/Pages/Dashboard/Timers.tsx`\n- `src/platform/routes/web.php` (updated)"
acceptance_criteria[9]: Timers page at /dashboard/timers shows time tracking reports,"Summary cards: total timer time, total break time, pomodoro count, session count",Date range filter with from/to date inputs,Daily breakdown stacked bar chart with timer/break/pomodoro hours,Per-project time breakdown chart,"Entry log table with type, label, task, project, duration",CSV export at /dashboard/timers/export with date range params,Duration formatted as hours and minutes,Responsive layout
story: OCD-26
epic: OCD-5
project: oap-cloud
projectKey: OCD
path: .projects/oap-cloud/OCD-5/OCD-26/OCD-74.toon
