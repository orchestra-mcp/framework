id: OCD-51
type: task
parent: OCD-14
title: Build Magic Login system (custom)
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 30
estimate_tokens: null
description: "Implement a custom magic login link system that sends a one-time email link for passwordless authentication.\n\n**Steps:**\n\n1. Create migration: `cd src/platform && php artisan make:migration create_magic_login_tokens_table`\nEdit `src/platform/database/migrations/*_create_magic_login_tokens_table.php`:\n```php\nSchema::create('magic_login_tokens', function (Blueprint $table) {\n    $table->id();\n    $table->foreignId('user_id')->nullable()->constrained()->cascadeOnDelete();\n    $table->string('email');\n    $table->string('token', 64)->unique();\n    $table->timestamp('expires_at');\n    $table->timestamp('used_at')->nullable();\n    $table->timestamps();\n    $table->index(['token', 'expires_at']);\n});\n```\n\n2. Create model: `php artisan make:model MagicLoginToken`\nEdit `src/platform/app/Models/MagicLoginToken.php`:\n```php\n<?php\nnamespace App\\Models;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\nuse Illuminate\\Support\\Str;\n\nclass MagicLoginToken extends Model\n{\n    protected $fillable = ['email', 'token', 'expires_at', 'user_id', 'used_at'];\n    protected $casts = ['expires_at' => 'datetime', 'used_at' => 'datetime'];\n\n    public function user(): BelongsTo\n    {\n        return $this->belongsTo(User::class);\n    }\n\n    public static function generateFor(string $email): self\n    {\n        $user = User::where('email', $email)->first();\n        return self::create([\n            'email' => $email,\n            'user_id' => $user?->id,\n            'token' => Str::random(64),\n            'expires_at' => now()->addMinutes(15),\n        ]);\n    }\n\n    public function isExpired(): bool\n    {\n        return $this->expires_at->isPast();\n    }\n\n    public function isUsed(): bool\n    {\n        return $this->used_at !== null;\n    }\n}\n```\n\n3. Create notification: `php artisan make:notification MagicLoginNotification`\nEdit `src/platform/app/Notifications/MagicLoginNotification.php`:\n```php\n<?php\nnamespace App\\Notifications;\n\nuse App\\Models\\MagicLoginToken;\nuse Illuminate\\Bus\\Queueable;\nuse Illuminate\\Notifications\\Messages\\MailMessage;\nuse Illuminate\\Notifications\\Notification;\n\nclass MagicLoginNotification extends Notification\n{\n    use Queueable;\n\n    public function __construct(private MagicLoginToken $token) {}\n\n    public function via($notifiable): array { return ['mail']; }\n\n    public function toMail($notifiable): MailMessage\n    {\n        $url = url(\"/magic-login/verify/{$this->token->token}\");\n        return (new MailMessage)\n            ->subject('Your Magic Login Link - Orchestra')\n            ->line('Click the button below to sign in to Orchestra.')\n            ->action('Sign In', $url)\n            ->line('This link expires in 15 minutes.')\n            ->line('If you did not request this, ignore this email.');\n    }\n}\n```\n\n4. Create controller: `php artisan make:controller Auth/MagicLoginController`\nEdit `src/platform/app/Http/Controllers/Auth/MagicLoginController.php`:\n```php\n<?php\nnamespace App\\Http\\Controllers\\Auth;\n\nuse App\\Http\\Controllers\\Controller;\nuse App\\Models\\MagicLoginToken;\nuse App\\Models\\User;\nuse App\\Notifications\\MagicLoginNotification;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Illuminate\\Support\\Facades\\Notification;\nuse Inertia\\Inertia;\n\nclass MagicLoginController extends Controller\n{\n    public function show()\n    {\n        return Inertia::render('Auth/MagicLogin', [\n            'status' => session('status'),\n        ]);\n    }\n\n    public function send(Request $request)\n    {\n        $request->validate(['email' => 'required|email']);\n        $token = MagicLoginToken::generateFor($request->email);\n\n        // Always send to the email (even if user doesn't exist) to prevent enumeration\n        $user = User::where('email', $request->email)->first();\n        if ($user) {\n            $user->notify(new MagicLoginNotification($token));\n        }\n\n        return back()->with('status', 'If an account exists, a magic login link has been sent.');\n    }\n\n    public function verify(string $token)\n    {\n        $magicToken = MagicLoginToken::where('token', $token)->first();\n        if (!$magicToken || $magicToken->isExpired() || $magicToken->isUsed()) {\n            return redirect('/login')->with('status', 'This magic link is invalid or has expired.');\n        }\n\n        $magicToken->update(['used_at' => now()]);\n\n        if ($magicToken->user) {\n            Auth::login($magicToken->user, remember: true);\n            return redirect('/dashboard');\n        }\n\n        return redirect('/login')->with('status', 'No account found for this email.');\n    }\n}\n```\n\n5. Create `src/platform/resources/js/Pages/Auth/MagicLogin.tsx`:\n```tsx\nimport { FormEvent } from 'react';\nimport { Link, useForm } from '@inertiajs/react';\nimport GuestLayout from '@/Layouts/GuestLayout';\n\ninterface Props { status?: string; }\n\nexport default function MagicLogin({ status }: Props) {\n    const { data, setData, post, processing, errors } = useForm({ email: '' });\n\n    const submit = (e: FormEvent) => {\n        e.preventDefault();\n        post('/magic-login');\n    };\n\n    return (\n        <GuestLayout title=\"Magic Login\">\n            <div className=\"flex min-h-[80vh] items-center justify-center\">\n                <div className=\"w-full max-w-md rounded-lg bg-white p-8 shadow-md\">\n                    <h2 className=\"mb-2 text-2xl font-bold text-gray-900\">Magic Login</h2>\n                    <p className=\"mb-6 text-sm text-gray-600\">Enter your email to receive a one-time login link.</p>\n                    {status && <div className=\"mb-4 rounded-md bg-green-50 p-3 text-sm text-green-700\">{status}</div>}\n                    <form onSubmit={submit} className=\"space-y-4\">\n                        <div>\n                            <label htmlFor=\"email\" className=\"block text-sm font-medium text-gray-700\">Email</label>\n                            <input id=\"email\" type=\"email\" value={data.email}\n                                onChange={e => setData('email', e.target.value)}\n                                className=\"mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500\"\n                                required autoFocus />\n                            {errors.email && <p className=\"mt-1 text-sm text-red-600\">{errors.email}</p>}\n                        </div>\n                        <button type=\"submit\" disabled={processing}\n                            className=\"w-full rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700 disabled:opacity-50\">\n                            {processing ? 'Sending...' : 'Send magic link'}\n                        </button>\n                    </form>\n                    <p className=\"mt-6 text-center text-sm text-gray-600\">\n                        <Link href=\"/login\" className=\"text-indigo-600 hover:underline\">Back to sign in</Link>\n                    </p>\n                </div>\n            </div>\n        </GuestLayout>\n    );\n}\n```\n\n6. Add routes in `src/platform/routes/web.php` (inside public/guest section):\n```php\nRoute::get('/magic-login', [MagicLoginController::class, 'show'])->name('magic-login');\nRoute::post('/magic-login', [MagicLoginController::class, 'send'])->name('magic-login.send');\nRoute::get('/magic-login/verify/{token}', [MagicLoginController::class, 'verify'])->name('magic-login.verify');\n```\n\n**File paths:**\n- `src/platform/database/migrations/*_create_magic_login_tokens_table.php`\n- `src/platform/app/Models/MagicLoginToken.php`\n- `src/platform/app/Notifications/MagicLoginNotification.php`\n- `src/platform/app/Http/Controllers/Auth/MagicLoginController.php`\n- `src/platform/resources/js/Pages/Auth/MagicLogin.tsx`\n- `src/platform/routes/web.php` (updated)"
acceptance_criteria[10]: "magic_login_tokens table created with email, token, expires_at, used_at columns","MagicLoginToken model with generateFor(), isExpired(), isUsed() methods",MagicLoginNotification sends email with login link,"MagicLoginController handles show, send, verify actions",MagicLogin.tsx renders email form,Magic link expires after 15 minutes,Magic link can only be used once,Email enumeration prevented (same response for existing/non-existing emails),Successful verification logs user in and redirects to /dashboard,"Routes registered: GET/POST /magic-login, GET /magic-login/verify/{token}"
story: OCD-14
epic: OCD-2
project: oap-cloud
projectKey: OCD
projectKey: OCD
path: .projects/oap-cloud/OCD-2/OCD-14/OCD-51.toon
