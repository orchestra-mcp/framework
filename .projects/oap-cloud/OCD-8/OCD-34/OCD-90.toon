id: OCD-90
type: task
parent: OCD-34
title: Create all event classes and register listeners
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 30
estimate_tokens: null
description: "Create all broadcast event classes for real-time features and register their listeners.\n\n**Steps:**\n\n1. Create event classes (some already exist from earlier tasks, create the remaining):\n```bash\ncd src/platform\nphp artisan make:event TaskUpdated        # already created in OCD-73\nphp artisan make:event TimeEntryCreated\nphp artisan make:event CommitSynced\nphp artisan make:event AgentStatusChanged  # already created in OCD-76\nphp artisan make:event AgentMessageReceived\nphp artisan make:event NotificationCreated\nphp artisan make:event SprintUpdated\nphp artisan make:event TeamMemberOnline\nphp artisan make:event TeamMemberOffline\n```\n\n2. Edit `src/platform/app/Events/TimeEntryCreated.php`:\n```php\n<?php\nnamespace App\\Events;\n\nuse App\\Models\\TimeEntry;\nuse Illuminate\\Broadcasting\\PrivateChannel;\nuse Illuminate\\Contracts\\Broadcasting\\ShouldBroadcast;\nuse Illuminate\\Foundation\\Events\\Dispatchable;\nuse Illuminate\\Broadcasting\\InteractsWithSockets;\nuse Illuminate\\Queue\\SerializesModels;\n\nclass TimeEntryCreated implements ShouldBroadcast\n{\n    use Dispatchable, InteractsWithSockets, SerializesModels;\n\n    public function __construct(public TimeEntry $entry) {}\n\n    public function broadcastOn(): array\n    {\n        return [\n            new PrivateChannel(\"user.{$this->entry->user_id}\"),\n            new PrivateChannel(\"team.{$this->entry->team_id}\"),\n        ];\n    }\n\n    public function broadcastWith(): array\n    {\n        return [\n            'id' => $this->entry->id,\n            'type' => $this->entry->type,\n            'label' => $this->entry->label,\n            'duration_seconds' => $this->entry->duration_seconds,\n            'started_at' => $this->entry->started_at->toISOString(),\n        ];\n    }\n}\n```\n\n3. Edit `src/platform/app/Events/CommitSynced.php`:\n```php\n<?php\nnamespace App\\Events;\n\nuse App\\Models\\CommitEntry;\nuse Illuminate\\Broadcasting\\PrivateChannel;\nuse Illuminate\\Contracts\\Broadcasting\\ShouldBroadcast;\nuse Illuminate\\Foundation\\Events\\Dispatchable;\nuse Illuminate\\Broadcasting\\InteractsWithSockets;\nuse Illuminate\\Queue\\SerializesModels;\n\nclass CommitSynced implements ShouldBroadcast\n{\n    use Dispatchable, InteractsWithSockets, SerializesModels;\n\n    public function __construct(public CommitEntry $commit) {}\n\n    public function broadcastOn(): array\n    {\n        return [\n            new PrivateChannel(\"user.{$this->commit->user_id}\"),\n            new PrivateChannel(\"team.{$this->commit->team_id}\"),\n        ];\n    }\n\n    public function broadcastWith(): array\n    {\n        return [\n            'id' => $this->commit->id,\n            'sha' => substr($this->commit->sha, 0, 7),\n            'message' => $this->commit->message,\n            'repo' => $this->commit->repo_name,\n            'committed_at' => $this->commit->committed_at->toISOString(),\n        ];\n    }\n}\n```\n\n4. Edit `src/platform/app/Events/SprintUpdated.php`:\n```php\n<?php\nnamespace App\\Events;\n\nuse App\\Models\\Sprint;\nuse Illuminate\\Broadcasting\\PrivateChannel;\nuse Illuminate\\Contracts\\Broadcasting\\ShouldBroadcast;\nuse Illuminate\\Foundation\\Events\\Dispatchable;\nuse Illuminate\\Broadcasting\\InteractsWithSockets;\nuse Illuminate\\Queue\\SerializesModels;\n\nclass SprintUpdated implements ShouldBroadcast\n{\n    use Dispatchable, InteractsWithSockets, SerializesModels;\n\n    public function __construct(public Sprint $sprint) {}\n\n    public function broadcastOn(): array\n    {\n        return [new PrivateChannel(\"team.{$this->sprint->team_id}\")];\n    }\n\n    public function broadcastWith(): array\n    {\n        return [\n            'id' => $this->sprint->id,\n            'name' => $this->sprint->name,\n            'status' => $this->sprint->status,\n            'completed_points' => $this->sprint->completed_points,\n            'total_points' => $this->sprint->total_points,\n        ];\n    }\n}\n```\n\n5. Create webhook support. Create controller: `php artisan make:controller Api/WebhookController`\nEdit `src/platform/app/Http/Controllers/Api/WebhookController.php`:\n```php\n<?php\nnamespace App\\Http\\Controllers\\Api;\n\nuse App\\Http\\Controllers\\Controller;\nuse Illuminate\\Http\\Request;\n\nclass WebhookController extends Controller\n{\n    public function github(Request $request)\n    {\n        // Verify GitHub webhook signature\n        $signature = $request->header('X-Hub-Signature-256');\n        $payload = $request->getContent();\n        $secret = config('services.github.webhook_secret');\n\n        if ($secret) {\n            $expected = 'sha256=' . hash_hmac('sha256', $payload, $secret);\n            if (!hash_equals($expected, $signature ?? '')) {\n                abort(403, 'Invalid signature');\n            }\n        }\n\n        $event = $request->header('X-GitHub-Event');\n        match ($event) {\n            'push' => $this->handleGitHubPush($request),\n            'pull_request' => $this->handleGitHubPR($request),\n            'issues' => $this->handleGitHubIssue($request),\n            default => null,\n        };\n\n        return response()->json(['status' => 'ok']);\n    }\n\n    private function handleGitHubPush(Request $request): void\n    {\n        // Parse commits and create CommitEntry records\n        // Broadcast CommitSynced events\n    }\n\n    private function handleGitHubPR(Request $request): void\n    {\n        // Parse PR data and create/update PullRequest records\n    }\n\n    private function handleGitHubIssue(Request $request): void\n    {\n        // Parse issue data and create/update Issue records\n    }\n}\n```\n\n6. Add webhook routes at `src/platform/routes/api.php`:\n```php\nRoute::post('/webhooks/github', [WebhookController::class, 'github'])->name('webhooks.github');\n```\n\n7. Register event-listener mappings in `src/platform/app/Providers/EventServiceProvider.php`:\n```php\nprotected $listen = [\n    \\Illuminate\\Auth\\Events\\Login::class => [\n        \\App\\Listeners\\UpdateLastLogin::class,\n    ],\n    // All other events are self-broadcasting (ShouldBroadcast)\n    // No separate listeners needed - they broadcast via Reverb automatically\n];\n```\n\n**File paths:**\n- `src/platform/app/Events/TimeEntryCreated.php`\n- `src/platform/app/Events/CommitSynced.php`\n- `src/platform/app/Events/SprintUpdated.php`\n- `src/platform/app/Events/TeamMemberOnline.php`\n- `src/platform/app/Events/TeamMemberOffline.php`\n- `src/platform/app/Http/Controllers/Api/WebhookController.php`\n- `src/platform/routes/api.php` (updated)\n- `src/platform/app/Providers/EventServiceProvider.php` (updated)"
acceptance_criteria[9]: All event classes implement ShouldBroadcast,"TimeEntryCreated broadcasts on user.{id} and team.{id} with entry details","CommitSynced broadcasts on user.{id} and team.{id} with commit details","SprintUpdated broadcasts on team.{id} with sprint progress",All events include broadcastWith() returning serializable data,GitHub webhook endpoint at POST /api/webhooks/github,Webhook signature verification for GitHub,"Webhook handles push, pull_request, issues events",EventServiceProvider has Login listener registered
story: OCD-34
epic: OCD-8
project: oap-cloud
projectKey: OCD
path: .projects/oap-cloud/OCD-8/OCD-34/OCD-90.toon
