id: OCD-66
type: task
parent: OCD-22
title: Build documentation file scanner and sidebar tree generator
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 30
estimate_tokens: null
description: "Create a backend service that scans docs/ and src/packages/*/docs/ directories, builds a navigation tree, and serves documentation pages.\n\n**Steps:**\n\n1. Create service at `src/platform/app/Services/DocumentationService.php`:\n```php\n<?php\nnamespace App\\Services;\n\nuse Illuminate\\Support\\Facades\\File;\nuse Illuminate\\Support\\Str;\n\nclass DocumentationService\n{\n    private array $docPaths;\n\n    public function __construct()\n    {\n        $this->docPaths = [\n            'root' => base_path('../docs'),\n            // Dynamically discover package docs\n            ...collect(glob(base_path('../packages/*/docs')))->mapWithKeys(\n                fn ($path) => [basename(dirname($path)) => $path]\n            )->toArray(),\n        ];\n    }\n\n    /**\n     * Build the full sidebar navigation tree from all doc directories.\n     */\n    public function getSidebarTree(): array\n    {\n        $tree = [];\n        foreach ($this->docPaths as $section => $basePath) {\n            if (!File::isDirectory($basePath)) continue;\n            $tree[] = [\n                'label' => $section === 'root' ? 'Documentation' : Str::title(str_replace('-', ' ', $section)),\n                'path' => $section === 'root' ? '/docs' : \"/docs/{$section}\",\n                'children' => $this->buildTree($basePath, $section === 'root' ? '' : $section),\n            ];\n        }\n        return $tree;\n    }\n\n    /**\n     * Recursively build a tree from a directory.\n     */\n    private function buildTree(string $directory, string $prefix): array\n    {\n        $items = [];\n        $entries = collect(File::directories($directory))->sort();\n\n        foreach ($entries as $dir) {\n            $name = basename($dir);\n            $path = $prefix ? \"{$prefix}/{$name}\" : $name;\n            $hasIndex = File::exists(\"{$dir}/README.md\");\n            $items[] = [\n                'label' => $this->pathToLabel($name),\n                'path' => \"/docs/{$path}\",\n                'has_index' => $hasIndex,\n                'children' => $this->buildTree($dir, $path),\n            ];\n        }\n\n        // Add markdown files (non-README)\n        $files = collect(File::files($directory))\n            ->filter(fn ($f) => $f->getExtension() === 'md' && $f->getFilename() !== 'README.md')\n            ->sort();\n\n        foreach ($files as $file) {\n            $name = $file->getFilenameWithoutExtension();\n            $path = $prefix ? \"{$prefix}/{$name}\" : $name;\n            $items[] = [\n                'label' => $this->pathToLabel($name),\n                'path' => \"/docs/{$path}\",\n                'has_index' => false,\n                'children' => [],\n            ];\n        }\n\n        return $items;\n    }\n\n    /**\n     * Get the content of a doc page by path.\n     * README.md files serve as index pages for directories.\n     */\n    public function getContent(string $path): ?array\n    {\n        // Try to find the file across all doc paths\n        foreach ($this->docPaths as $section => $basePath) {\n            $prefix = $section === 'root' ? '' : $section;\n            $relativePath = $prefix ? Str::after($path, \"{$prefix}/\") : $path;\n\n            // Try as directory with README.md\n            $readmePath = \"{$basePath}/{$relativePath}/README.md\";\n            if ($relativePath === '' || $relativePath === $prefix) {\n                $readmePath = \"{$basePath}/README.md\";\n            }\n            if (File::exists($readmePath)) {\n                return [\n                    'content' => File::get($readmePath),\n                    'title' => $this->extractTitle(File::get($readmePath)),\n                    'edit_url' => $this->getGitHubEditUrl($readmePath),\n                    'last_modified' => File::lastModified($readmePath),\n                ];\n            }\n\n            // Try as .md file\n            $mdPath = \"{$basePath}/{$relativePath}.md\";\n            if (File::exists($mdPath)) {\n                return [\n                    'content' => File::get($mdPath),\n                    'title' => $this->extractTitle(File::get($mdPath)),\n                    'edit_url' => $this->getGitHubEditUrl($mdPath),\n                    'last_modified' => File::lastModified($mdPath),\n                ];\n            }\n        }\n\n        return null;\n    }\n\n    private function extractTitle(string $markdown): string\n    {\n        if (preg_match('/^#\\s+(.+)$/m', $markdown, $matches)) {\n            return $matches[1];\n        }\n        return 'Untitled';\n    }\n\n    private function pathToLabel(string $name): string\n    {\n        return Str::title(str_replace(['-', '_'], ' ', $name));\n    }\n\n    private function getGitHubEditUrl(string $filePath): string\n    {\n        $repoBase = config('app.github_repo_url', 'https://github.com/orchestra/orchestra-app');\n        $relativePath = Str::after($filePath, base_path('../'));\n        return \"{$repoBase}/edit/main/{$relativePath}\";\n    }\n}\n```\n\n2. Create controller: `cd src/platform && php artisan make:controller DocsController`\nEdit `src/platform/app/Http/Controllers/DocsController.php`:\n```php\n<?php\nnamespace App\\Http\\Controllers;\n\nuse App\\Services\\DocumentationService;\nuse Inertia\\Inertia;\n\nclass DocsController extends Controller\n{\n    public function __construct(private DocumentationService $docs) {}\n\n    public function show(string $path = '')\n    {\n        $content = $this->docs->getContent($path);\n        if (!$content) {\n            abort(404, 'Documentation page not found.');\n        }\n\n        return Inertia::render('Docs/Show', [\n            'sidebar' => $this->docs->getSidebarTree(),\n            'page' => $content,\n            'breadcrumbs' => $this->buildBreadcrumbs($path),\n            'currentPath' => \"/docs/{$path}\",\n        ]);\n    }\n\n    private function buildBreadcrumbs(string $path): array\n    {\n        $parts = array_filter(explode('/', $path));\n        $crumbs = [['label' => 'Docs', 'path' => '/docs']];\n        $current = '';\n        foreach ($parts as $part) {\n            $current .= ($current ? '/' : '') . $part;\n            $crumbs[] = ['label' => \\Str::title(str_replace('-', ' ', $part)), 'path' => \"/docs/{$current}\"];\n        }\n        return $crumbs;\n    }\n}\n```\n\n3. Add route in `src/platform/routes/web.php`:\n```php\nRoute::get('/docs/{path?}', [DocsController::class, 'show'])->name('docs.show')->where('path', '.*');\n```\n\n4. Add config for GitHub repo URL in `.env`:\n```\nGITHUB_REPO_URL=https://github.com/orchestra/orchestra-app\n```\nAnd in `src/platform/config/app.php`:\n```php\n'github_repo_url' => env('GITHUB_REPO_URL', 'https://github.com/orchestra/orchestra-app'),\n```\n\n**File paths:**\n- `src/platform/app/Services/DocumentationService.php`\n- `src/platform/app/Http/Controllers/DocsController.php`\n- `src/platform/routes/web.php` (updated)\n- `src/platform/config/app.php` (updated)"
acceptance_criteria[9]: DocumentationService scans docs/ and src/packages/*/docs/ directories,"getSidebarTree() returns nested tree with label, path, children",README.md files serve as directory index pages,"getContent() returns markdown content, title, edit URL, last modified",Title extracted from first H1 in markdown,Breadcrumbs generated from path segments,Edit on GitHub URL generated from file path,404 returned for non-existent docs,"Wildcard route /docs/{path?} catches all doc paths"
story: OCD-22
epic: OCD-4
project: oap-cloud
projectKey: OCD
path: .projects/oap-cloud/OCD-4/OCD-22/OCD-66.toon
