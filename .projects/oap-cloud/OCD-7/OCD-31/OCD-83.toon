id: OCD-83
type: task
parent: OCD-31
title: Build Admin entity CRUD system with data tables
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 35
estimate_tokens: null
description: "Create a generic admin CRUD system for managing all database entities.\n\n**Steps:**\n\n1. Create base admin controller: `cd src/platform && php artisan make:controller Admin/AdminController`\nEdit `src/platform/app/Http/Controllers/Admin/AdminController.php`:\n```php\n<?php\nnamespace App\\Http\\Controllers\\Admin;\n\nuse App\\Http\\Controllers\\Controller;\nuse Inertia\\Inertia;\n\nclass AdminController extends Controller\n{\n    public function index()\n    {\n        return Inertia::render('Admin/Index', [\n            'stats' => [\n                'users' => \\App\\Models\\User::count(),\n                'teams' => \\App\\Models\\Team::count(),\n                'extensions' => \\App\\Models\\Extension::count(),\n                'posts' => \\App\\Models\\Post::count(),\n            ],\n        ]);\n    }\n}\n```\n\n2. Create user management controller: `php artisan make:controller Admin/UserManagementController`\nEdit `src/platform/app/Http/Controllers/Admin/UserManagementController.php`:\n```php\n<?php\nnamespace App\\Http\\Controllers\\Admin;\n\nuse App\\Http\\Controllers\\Controller;\nuse App\\Models\\User;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Illuminate\\Support\\Facades\\Hash;\nuse Inertia\\Inertia;\n\nclass UserManagementController extends Controller\n{\n    public function index(Request $request)\n    {\n        $query = User::query();\n\n        if ($request->filled('search')) {\n            $search = $request->search;\n            $query->where(fn ($q) => $q->where('name', 'like', \"%{$search}%\")->orWhere('email', 'like', \"%{$search}%\"));\n        }\n        if ($request->filled('role')) {\n            if ($request->role === 'admin') { $query->where('is_admin', true); }\n        }\n\n        return Inertia::render('Admin/Users', [\n            'users' => $query->orderByDesc('created_at')->paginate(25)->through(fn ($user) => [\n                'id' => $user->id,\n                'name' => $user->name,\n                'email' => $user->email,\n                'is_admin' => $user->is_admin,\n                'is_banned' => $user->banned_at !== null,\n                'created_at' => $user->created_at->format('M d, Y'),\n                'teams_count' => $user->allTeams()->count(),\n            ]),\n            'filters' => $request->only(['search', 'role']),\n        ]);\n    }\n\n    public function ban(Request $request, int $userId)\n    {\n        $user = User::findOrFail($userId);\n        $user->update(['banned_at' => now()]);\n        return back()->with('status', 'User banned.');\n    }\n\n    public function unban(Request $request, int $userId)\n    {\n        $user = User::findOrFail($userId);\n        $user->update(['banned_at' => null]);\n        return back()->with('status', 'User unbanned.');\n    }\n\n    public function impersonate(Request $request, int $userId)\n    {\n        $user = User::findOrFail($userId);\n        session(['impersonating_from' => Auth::id()]);\n        Auth::login($user);\n        return redirect('/dashboard');\n    }\n\n    public function stopImpersonating(Request $request)\n    {\n        $originalId = session('impersonating_from');\n        if ($originalId) {\n            Auth::login(User::findOrFail($originalId));\n            session()->forget('impersonating_from');\n        }\n        return redirect('/admin');\n    }\n\n    public function resetPassword(Request $request, int $userId)\n    {\n        $user = User::findOrFail($userId);\n        $newPassword = \\Str::random(12);\n        $user->update(['password' => Hash::make($newPassword)]);\n        return back()->with('status', \"Password reset. New password: {$newPassword}\");\n    }\n\n    public function export(Request $request)\n    {\n        $users = User::all();\n        $csv = \"ID,Name,Email,Admin,Created\\n\";\n        foreach ($users as $user) {\n            $csv .= \"{$user->id},{$user->name},{$user->email},\" . ($user->is_admin ? 'Yes' : 'No') . \",{$user->created_at}\\n\";\n        }\n        return response($csv, 200, [\n            'Content-Type' => 'text/csv',\n            'Content-Disposition' => 'attachment; filename=users-export.csv',\n        ]);\n    }\n}\n```\n\n3. Add `banned_at` column: `php artisan make:migration add_banned_at_to_users_table`\n```php\nSchema::table('users', function (Blueprint $table) {\n    $table->timestamp('banned_at')->nullable()->after('is_admin');\n});\n```\n\n4. Create `src/platform/resources/js/Pages/Admin/Index.tsx`:\n- Admin dashboard with stats cards (users, teams, extensions, posts)\n- Quick links to each admin section\n\n5. Create `src/platform/resources/js/Pages/Admin/Users.tsx`:\n- Data table with: ID, Name, Email, Admin badge, Banned badge, Created, Teams count\n- Search input\n- Actions dropdown per row: Ban/Unban, Impersonate, Reset Password\n- Confirmation dialogs for destructive actions\n- CSV export button\n- Pagination\n\n6. Add routes (inside admin middleware group):\n```php\nRoute::get('/admin', [AdminController::class, 'index'])->name('admin.index');\nRoute::get('/admin/users', [UserManagementController::class, 'index'])->name('admin.users');\nRoute::post('/admin/users/{user}/ban', [UserManagementController::class, 'ban'])->name('admin.users.ban');\nRoute::post('/admin/users/{user}/unban', [UserManagementController::class, 'unban'])->name('admin.users.unban');\nRoute::post('/admin/users/{user}/impersonate', [UserManagementController::class, 'impersonate'])->name('admin.users.impersonate');\nRoute::post('/admin/stop-impersonating', [UserManagementController::class, 'stopImpersonating'])->name('admin.stopImpersonating');\nRoute::post('/admin/users/{user}/reset-password', [UserManagementController::class, 'resetPassword'])->name('admin.users.resetPassword');\nRoute::get('/admin/users/export', [UserManagementController::class, 'export'])->name('admin.users.export');\n```\n\n**File paths:**\n- `src/platform/app/Http/Controllers/Admin/AdminController.php`\n- `src/platform/app/Http/Controllers/Admin/UserManagementController.php`\n- `src/platform/database/migrations/*_add_banned_at_to_users_table.php`\n- `src/platform/resources/js/Pages/Admin/Index.tsx`\n- `src/platform/resources/js/Pages/Admin/Users.tsx`\n- `src/platform/routes/web.php` (updated)"
acceptance_criteria[11]: Admin index page at /admin with stats cards,Users page at /admin/users with paginated data table,Search users by name or email,Ban/Unban user actions,"Impersonate user (logs in as user, stores original admin ID in session)",Stop impersonating returns to admin account,Reset password generates random password and shows it,CSV export downloads all users,banned_at column added to users table,"Confirmation dialogs for ban, reset password",Admin-only middleware enforced
story: OCD-31
epic: OCD-7
project: oap-cloud
projectKey: OCD
path: .projects/oap-cloud/OCD-7/OCD-31/OCD-83.toon
