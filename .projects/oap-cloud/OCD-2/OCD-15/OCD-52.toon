id: OCD-52
type: task
parent: OCD-15
title: Build Profile page with avatar upload (Spatie Media Library)
status: backlog
created: 2026-02-09
assignee: null
estimate_minutes: 30
estimate_tokens: null
description: "Create the Profile page with avatar upload using Spatie Media Library, tabbed interface for profile sections.\n\n**Steps:**\n\n1. Create a profile controller: `cd src/platform && php artisan make:controller ProfileController`\nEdit `src/platform/app/Http/Controllers/ProfileController.php`:\n```php\n<?php\nnamespace App\\Http\\Controllers;\n\nuse Illuminate\\Http\\Request;\nuse Inertia\\Inertia;\n\nclass ProfileController extends Controller\n{\n    public function show(Request $request)\n    {\n        $user = $request->user();\n        return Inertia::render('Profile/Show', [\n            'user' => $user->only('id', 'name', 'email', 'created_at'),\n            'avatar' => $user->getFirstMediaUrl('avatar', 'medium') ?: null,\n            'avatarThumb' => $user->getFirstMediaUrl('avatar', 'thumb') ?: null,\n            'sessions' => $this->getActiveSessions($request),\n            'tokens' => $user->tokens->map(fn ($token) => [\n                'id' => $token->id,\n                'name' => $token->name,\n                'abilities' => $token->abilities,\n                'last_used_at' => $token->last_used_at?->diffForHumans(),\n                'created_at' => $token->created_at->diffForHumans(),\n            ]),\n            'twoFactorEnabled' => $user->hasEnabledTwoFactorAuthentication(),\n            'qrCodeSvg' => $user->twoFactorQrCodeSvg(),\n            'recoveryCodes' => $user->recoveryCodes(),\n            'setupSecret' => decrypt($user->two_factor_secret ?? ''),\n        ]);\n    }\n\n    public function updateAvatar(Request $request)\n    {\n        $request->validate(['avatar' => 'required|image|mimes:jpeg,png,webp|max:5120']);\n        $user = $request->user();\n        $user->clearMediaCollection('avatar');\n        $user->addMediaFromRequest('avatar')->toMediaCollection('avatar');\n        return back()->with('status', 'Avatar updated.');\n    }\n\n    public function removeAvatar(Request $request)\n    {\n        $request->user()->clearMediaCollection('avatar');\n        return back()->with('status', 'Avatar removed.');\n    }\n\n    private function getActiveSessions(Request $request): array\n    {\n        if (config('session.driver') !== 'database') return [];\n        return collect(\n            \\DB::table('sessions')\n                ->where('user_id', $request->user()->id)\n                ->orderByDesc('last_activity')\n                ->get()\n        )->map(fn ($session) => [\n            'id' => $session->id,\n            'ip_address' => $session->ip_address,\n            'user_agent' => $session->user_agent,\n            'last_active' => \\Carbon\\Carbon::createFromTimestamp($session->last_activity)->diffForHumans(),\n            'is_current' => $session->id === $request->session()->getId(),\n        ])->toArray();\n    }\n}\n```\n\n2. Create `src/platform/resources/js/Pages/Profile/Show.tsx`:\n```tsx\nimport { useState } from 'react';\nimport AppLayout from '@/Layouts/AppLayout';\nimport AvatarUpload from '@/Components/AvatarUpload';\nimport TwoFactorSetup from '@/Components/TwoFactorSetup';\nimport ActiveSessions from '@/Components/ActiveSessions';\nimport ApiTokens from '@/Components/ApiTokens';\nimport PasswordChange from '@/Components/PasswordChange';\n\ninterface Props {\n    user: { id: number; name: string; email: string; created_at: string };\n    avatar: string | null;\n    avatarThumb: string | null;\n    sessions: Array<{ id: string; ip_address: string; user_agent: string; last_active: string; is_current: boolean }>;\n    tokens: Array<{ id: number; name: string; abilities: string[]; last_used_at: string | null; created_at: string }>;\n    twoFactorEnabled: boolean;\n    qrCodeSvg?: string;\n    recoveryCodes?: string[];\n    setupSecret?: string;\n}\n\nconst tabs = ['Profile', 'Security', 'Devices', 'API Keys'] as const;\n\nexport default function Show(props: Props) {\n    const [activeTab, setActiveTab] = useState<typeof tabs[number]>('Profile');\n\n    return (\n        <AppLayout title=\"Profile\">\n            <div className=\"mx-auto max-w-4xl\">\n                {/* Tab Navigation */}\n                <div className=\"border-b border-gray-200 mb-6\">\n                    <nav className=\"flex gap-4\">\n                        {tabs.map(tab => (\n                            <button key={tab} onClick={() => setActiveTab(tab)}\n                                className={`py-3 px-1 border-b-2 text-sm font-medium ${\n                                    activeTab === tab\n                                        ? 'border-indigo-600 text-indigo-600'\n                                        : 'border-transparent text-gray-500 hover:text-gray-700'\n                                }`}>\n                                {tab}\n                            </button>\n                        ))}\n                    </nav>\n                </div>\n                {/* Tab Content */}\n                {activeTab === 'Profile' && <AvatarUpload avatar={props.avatar} user={props.user} />}\n                {activeTab === 'Security' && (\n                    <div className=\"space-y-8\">\n                        <PasswordChange />\n                        <TwoFactorSetup\n                            twoFactorEnabled={props.twoFactorEnabled}\n                            qrCodeSvg={props.qrCodeSvg}\n                            recoveryCodes={props.recoveryCodes}\n                            setupSecret={props.setupSecret}\n                        />\n                    </div>\n                )}\n                {activeTab === 'Devices' && <ActiveSessions sessions={props.sessions} />}\n                {activeTab === 'API Keys' && <ApiTokens tokens={props.tokens} />}\n            </div>\n        </AppLayout>\n    );\n}\n```\n\n3. Add routes in `src/platform/routes/web.php` (inside authenticated group):\n```php\nRoute::get('/profile', [ProfileController::class, 'show'])->name('profile.show');\nRoute::post('/profile/avatar', [ProfileController::class, 'updateAvatar'])->name('profile.avatar.update');\nRoute::delete('/profile/avatar', [ProfileController::class, 'removeAvatar'])->name('profile.avatar.remove');\n```\n\n**File paths:**\n- `src/platform/app/Http/Controllers/ProfileController.php`\n- `src/platform/resources/js/Pages/Profile/Show.tsx`\n- `src/platform/routes/web.php` (updated)"
acceptance_criteria[8]: "ProfileController returns user data, avatar URLs, sessions, tokens, 2FA status",Avatar upload via POST /profile/avatar using Spatie Media Library,Avatar removal via DELETE /profile/avatar,"Profile/Show.tsx renders with tabbed interface (Profile, Security, Devices, API Keys)",Avatar displayed with thumb conversion,"Active sessions list shows IP, user agent, last active","API tokens listed with name, abilities, last used",2FA setup section integrated via TwoFactorSetup component
story: OCD-15
epic: OCD-2
project: oap-cloud
projectKey: OCD
projectKey: OCD
path: .projects/oap-cloud/OCD-2/OCD-15/OCD-52.toon
